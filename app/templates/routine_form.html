{% extends "base.html" %}

{% block title %}Crear Rutina{% endblock %}

{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Crear nueva rutina</h2>
</div>
<a href="/routines">⬅ Volver a Mis Rutinas</a>
<hr>

<article>
    <form id="routine-form">
        <div>
            <label for="routine-name">Nombre de la rutina</label>
            <input type="text" id="routine-name" required>
        </div>
        <hr>
        <h4>Sesiones</h4>
        <div id="sessions-container"></div>
        
        <button type="button" class="secondary" id="add-session-btn" style="margin-bottom: 1rem;">
            + Agregar sesión
        </button>
        <hr>
        <button type="submit">
            Guardar y Crear rutina
        </button>
    </form>
</article>

{#
<template id="sessions-template">
    <select>
        <option value="">-- Ninguna --</option>
        {% for s in sessions %}
        <option value="{{ s.id }}">{{ s.session_name }}</option>
        {% endfor %}
    </select>
</template>
#}


<script>
const sessionsContainer = document.getElementById("sessions-container");
const addSessionBtn = document.getElementById("add-session-btn");
let sessionCount = 0;
let exerciseCount = 0;

addSessionBtn.addEventListener("click", () => {
    const sessionId = sessionCount++;
    
    const sessionArticle = document.createElement("article");
    sessionArticle.dataset.sessionIndex = sessionId;
    sessionArticle.className = "session-block";
    sessionArticle.style.marginTop = "1em";

    sessionArticle.innerHTML = `
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0;">Sesión ${sessionId + 1}</h5>
            <button type="button" class="secondary outline remove-session-btn" style="margin: 0; background-color:#d32f2f; border-color:#d32f2f;">
                Eliminar sesión
            </button>
        </header>
        
        <label for="session-name-${sessionId}">Nombre de la sesión</label>
        <input type="text" id="session-name-${sessionId}" class="session-name" required>
        
        <h6 style="margin-top: 1em; margin-bottom: 0.5em;">Ejercicios</h6>
        <div class="exercises-container"></div>
        <button type="button" class="secondary outline add-exercise-btn" style="margin-top: 1em;">
            + Agregar ejercicio
        </button>
    `;

    sessionsContainer.appendChild(sessionArticle);

    // PASO 3: Comentamos la lógica de JS que poblaba el dropdown
    /*
    const selectElement = sessionArticle.querySelector(".session-existing");
    const template = document.getElementById("sessions-template");
    const templateContent = template.content.querySelector("select");
    if (selectElement && templateContent) {
        selectElement.innerHTML = templateContent.innerHTML;
    }
    */
});

// (El resto del script de delegación de eventos y submit no cambia)

document.addEventListener("click", (e) => {
    if (e.target.classList.contains("add-exercise-btn")) {
        const exercisesContainer = e.target.previousElementSibling;
        
        if (exercisesContainer && exercisesContainer.classList.contains("exercises-container")) {
            const exDiv = document.createElement("div");
            // Usamos variables de Pico.css para los bordes, para que matchee el theme
            exDiv.style = "border: 1px solid var(--pico-card-border-color); padding: 1em; margin-bottom: 1em; border-radius: var(--pico-border-radius);";
            exDiv.innerHTML = `
                <label>Nombre del ejercicio</label>
                <input type="text" class="exercise-name" required>
                <div style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 1em; margin-top: 1em;">
                    <div>
                        <label>Series</label>
                        <input type="number" class="exercise-sets" min="1" required>
                    </div>
                    <div>
                        <label>Reps</label>
                        <input type="number" class="exercise-reps" min="1" required>
                    </div>
                </div>
                <label style="margin-top: 1em;">Peso (opcional)</label>
                <input type="number" step="0.1" class="exercise-weight" placeholder="kg">
                <button type="button" class="secondary outline remove-exercise-btn" style="margin-top: 1em;">
                    Quitar ejercicio
                </button>
            `;
            exercisesContainer.appendChild(exDiv);
        }
    }

    if (e.target.classList.contains("remove-session-btn")) {
        e.target.closest(".session-block").remove();
    }

    if (e.target.classList.contains("remove-exercise-btn")) {
        e.target.parentElement.remove();
    }
});

document.getElementById("routine-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const routineName = document.getElementById("routine-name").value;

    const sessions = [];
    document.querySelectorAll(".session-block").forEach(sessionDiv => {
        const name = sessionDiv.querySelector(".session-name").value.trim();
        
        // PASO 4: Hardcodeamos 'existing' a null para que siempre cree una nueva sesión
        const existing = null;
        // const existing = sessionDiv.querySelector(".session-existing").value; // <-- Línea original comentada

        const exercises = [];
        sessionDiv.querySelectorAll(".exercises-container > div").forEach(exDiv => {
            const weightVal = exDiv.querySelector(".exercise-weight").value;
            exercises.push({
                exercise_name: exDiv.querySelector(".exercise-name").value,
                target_sets: parseInt(exDiv.querySelector(".exercise-sets").value || 0),
                target_reps: parseInt(exDiv.querySelector(".exercise-reps").value || 0),
                target_weight: weightVal ? parseFloat(weightVal) : null
            });
        });

        sessions.push({
            id: existing ? parseInt(existing) : null,
            session_name: existing ? null : (name || null),
            exercises: existing ? [] : exercises
        });
    });

    const payload = {
        name: routineName,
        sessions: sessions
    };

    const response = await fetch("/routines/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (response.ok) {
        window.location.href = "/routines";
    } else {
        const errorData = await response.json();
        alert("Error al crear la rutina: " + (errorData.detail || "Error desconocido"));
    }
});
</script>

{% endblock %}