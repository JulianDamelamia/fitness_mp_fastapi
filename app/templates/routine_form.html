{% extends "base.html" %}

{% block title %}Crear Rutina{% endblock %}

{% block content %}
<div>
    <h2>Crear nueva rutina</h2>
    
    <pre style="background: #fff; color: #000; padding: 10px; border: 1px solid red;">
Debug (Datos recibidos): {{ sessions }}
</pre>

    <form id="routine-form">
        <div>
            <label for="routine-name">Nombre de la rutina</label>
            <input type="text" id="routine-name" required>
        </div>
        <hr>
        <h4>Sesiones</h4>
        <div id="sessions-container"></div>
        <button type="button" class="secondary" id="add-session-btn">
            + Agregar sesión
        </button>
        <hr>
        <button type="submit">
            Crear rutina
        </button>
    </form>
</div>

<template id="sessions-template">
    <select>
        <option value="">-- Ninguna --</option>
        {% for s in sessions %}
        <option value="{{ s.id }}">{{ s.session_name }}</option>
        {% endfor %}
    </select>
</template>


<script>
const sessionsContainer = document.getElementById("sessions-container");
const addSessionBtn = document.getElementById("add-session-btn");
let sessionCount = 0;
let exerciseCount = 0;

addSessionBtn.addEventListener("click", () => {
    const sessionId = sessionCount++;
    
    const sessionArticle = document.createElement("article");
    sessionArticle.dataset.sessionIndex = sessionId;
    sessionArticle.className = "session-block";
    sessionArticle.style.marginTop = "1em";

    sessionArticle.innerHTML = `
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0;">Sesión ${sessionId + 1}</h5>
            <button type="button" class="secondary outline remove-session-btn" style="margin: 0; background-color:#d32f2f; border-color:#d32f2f;">
                Eliminar sesión
            </button>
        </header>
        
        <label for="session-name-${sessionId}">Nombre de la sesión</label>
        <input type="text" id="session-name-${sessionId}" class="session-name">
        
        <label for="session-existing-${sessionId}" style="margin-top: 1em;">O seleccionar existente</label>
        <select id="session-existing-${sessionId}" class="session-existing">
            </select>
        
        <h6 style="margin-top: 1em; margin-bottom: 0.5em;">Ejercicios</h6>
        <div class="exercises-container"></div>
        <button type="button" class="secondary outline add-exercise-btn" style="margin-top: 1em;">
            + Agregar ejercicio
        </button>
    `;

    sessionsContainer.appendChild(sessionArticle);

    // --- INICIO DE CORRECCIÓN (Lógica de JS) ---
    // 1. Buscamos el <select> vacío que acabamos de crear
    const selectElement = sessionArticle.querySelector(".session-existing");

    // 2. Buscamos nuestro "molde"
    const template = document.getElementById("sessions-template");

    // 3. Obtenemos el contenido del molde (esta es la forma correcta)
    const templateContent = template.content.querySelector("select");

    // 4. Copiamos el HTML de las opciones del molde al <select> vacío
    if (selectElement && templateContent) {
        selectElement.innerHTML = templateContent.innerHTML;
    }
    // --- FIN DE CORRECCIÓN (Lógica de JS) ---
});

// (El resto del script de delegación de eventos y submit no cambia)

document.addEventListener("click", (e) => {
    if (e.target.classList.contains("add-exercise-btn")) {
        const exercisesContainer = e.target.previousElementSibling;
        
        if (exercisesContainer && exercisesContainer.classList.contains("exercises-container")) {
            const exDiv = document.createElement("div");
            exDiv.style = "border: 1px solid #ddd; padding: 1em; margin-bottom: 1em; border-radius: 8px;";
            exDiv.innerHTML = `
                <label>Nombre del ejercicio</label>
                <input type="text" class="exercise-name" required>
                <div style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 1em; margin-top: 1em;">
                    <div>
                        <label>Series</label>
                        <input type="number" class="exercise-sets" min="1">
                    </div>
                    <div>
                        <label>Reps</label>
                        <input type="number" class="exercise-reps" min="1">
                    </div>
                </div>
                <label style="margin-top: 1em;">Peso (opcional)</label>
                <input type="number" step="0.1" class="exercise-weight" placeholder="kg">
                <button type="button" class="secondary outline remove-exercise-btn" style="margin-top: 1em;">
                    Quitar ejercicio
                </button>
            `;
            exercisesContainer.appendChild(exDiv);
        }
    }

    if (e.target.classList.contains("remove-session-btn")) {
        e.target.closest(".session-block").remove();
    }

    if (e.target.classList.contains("remove-exercise-btn")) {
        e.target.parentElement.remove();
    }
});

document.getElementById("routine-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const routineName = document.getElementById("routine-name").value;

    const sessions = [];
    document.querySelectorAll(".session-block").forEach(sessionDiv => {
        const name = sessionDiv.querySelector(".session-name").value.trim();
        const existing = sessionDiv.querySelector(".session-existing").value;

        const exercises = [];
        sessionDiv.querySelectorAll(".exercises-container > div").forEach(exDiv => {
            const weightVal = exDiv.querySelector(".exercise-weight").value;
            exercises.push({
                exercise_name: exDiv.querySelector(".exercise-name").value,
                target_sets: parseInt(exDiv.querySelector(".exercise-sets").value || 0),
                target_reps: parseInt(exDiv.querySelector(".exercise-reps").value || 0),
                target_weight: weightVal ? parseFloat(weightVal) : null
            });
        });

        sessions.push({
            id: existing ? parseInt(existing) : null,
            session_name: existing ? null : (name || null),
            exercises: existing ? [] : exercises
        });
    });

    const payload = {
        name: routineName,
        sessions: sessions
    };

    const response = await fetch("/routines/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (response.ok) {
        window.location.href = "/routines";
    } else {
        const errorData = await response.json();
        alert("Error al crear la rutina: " + (errorData.detail || "Error desconocido"));
    }
});
</script>

{% endblock %}